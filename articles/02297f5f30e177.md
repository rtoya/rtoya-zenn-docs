---
title: "ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆå¾Œã«ä½•ã‚’ã™ã¹ãã‹ã‚’ç«¯çš„ã«æ¡ˆå†…ã™ã‚‹"
emoji: "ğŸ“˜"
type: "tech"
topics: ["githubactions", "github", "terraform"]
published: true
publication_name: "atrae"
---

# æ¦‚è¦

Githubã§PRã‚’ä½œæˆå¾Œã‚„ãƒãƒ¼ã‚¸ã¾ã§ã«ã‚„ã£ã¦æ¬²ã—ã„ã“ã¨ã‚’æ¡ˆå†…ã™ã‚‹ä»•çµ„ã¿ã‚’Github Actionsã§ä½œæˆã—ã¾ã—ãŸã€‚

# èƒŒæ™¯

å¼Šç¤¾ã§ã¯terraformã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã¨ã—ã¦[branch-deploy](https://github.com/github/branch-deploy)ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã¯ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä»»æ„ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ‰“ã¤ã“ã¨ã§`terraform plan`, `terraform apply`ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚

åé¢ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã‚„ã‚¿ã‚°ã‚’æ‰“ã¤ã“ã¨ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«ã™ã‚‹ã“ã¨ãŒå¤šã„ã‹ã¨æ€ã‚ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚‰ã®å·®ç•°ã«ã‚ˆã‚Šã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ‰“ã£ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã™ã‚‹å‰ã«ãƒãƒ¼ã‚¸ã‚’ã—ã¦ã—ã¾ã†ã‚±ãƒ¼ã‚¹ãªã©ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚

ãã“ã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚ŒãŸéš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ãªã©ã‚’æ¡ˆå†…ã™ã‚‹ã“ã¨ã§èª¤ã£ãŸæ“ä½œã®ç™ºç”Ÿã™ã‚‹ä»¶æ•°ã‚’æ¸›ã‚‰ãã†ã¨è€ƒãˆã¾ã—ãŸã€‚

# æ–¹æ³•

ä¸Šè¿°ã®é€šã‚Šã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚ªãƒ¼ãƒ—ãƒ³ã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç™ºç«ã™ã‚‹Github Actionsã‚’ä½œæˆã—ã¦ã€ãã®Actionsã§ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã™ã“ã¨ã§æ¡ˆå†…ã™ã‚‹æ–¹æ³•ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

å·¥å¤«ã—ã¦ã„ã‚‹ç‚¹ã¯ä¸‹è¨˜ã®ã¨ãŠã‚Šã§ã™ã€‚

- Actionsè‡ªä½“ã‚’å†åˆ©ç”¨å¯èƒ½ã«ã—ã¦ã€ä»–ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚‚åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
- BotãŒä½œæˆã—ãŸéš›ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ®‹ã•ãªã„ã‚ˆã†ã«ã€`excluded-users` ã§ä»»æ„ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é™¤å¤–ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
- ã‚³ãƒ¡ãƒ³ãƒˆè‡ªä½“ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’ç°¡å˜ã«ã™ã‚‹ãŸã‚ã«åˆ¥ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

æœ¬ä½“ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«å®šç¾©ã—ã¾ã—ãŸã€‚
ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¨˜è¼‰ã™ã‚‹ãŸã‚ã€ãƒˆãƒªã‚¬ãƒ¼ã‚’å·¥å¤«ã™ã‚Œã°åˆ¥ã®ä½¿ã„æ–¹ã‚‚ã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```yml:.github/workflows/_comment-markdown-file.yml
name: Comment Markdown File on PR

on:
  workflow_call:
    inputs:
      markdown-file-path:
        description: 'Path to the markdown file to post as a comment'
        required: true
        type: string
      excluded-users:
        description: 'Comma-separated list of users to exclude from commenting (e.g., "renovate[bot],dependabot[bot]")'
        required: false
        type: string
        default: ''
      pr-number:
        description: 'Pull request number (defaults to the PR that triggered the workflow)'
        required: false
        type: number

jobs:
  comment-markdown:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Check if user should be excluded
        id: check-user
        run: |
          EXCLUDED_USERS="${{ inputs.excluded-users }}"
          CURRENT_USER="${{ github.event.pull_request.user.login }}"

          if [ -z "$EXCLUDED_USERS" ]; then
            echo "should-comment=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IFS=',' read -ra USERS <<< "$EXCLUDED_USERS"
          for user in "${USERS[@]}"; do
            user=$(echo "$user" | xargs)  # trim whitespace
            if [ "$user" = "$CURRENT_USER" ]; then
              echo "User $CURRENT_USER is in the excluded list"
              echo "should-comment=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          done

          echo "should-comment=true" >> "$GITHUB_OUTPUT"

      - name: Post markdown file as comment
        if: steps.check-user.outputs.should-comment == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          PR_NUMBER=${{ inputs.pr-number }}
          if [ -z "$PR_NUMBER" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi

          gh pr comment "$PR_NUMBER" --body-file "${{ inputs.markdown-file-path }}"
```

å‘¼ã³å‡ºã—æ–¹ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yml:.github/workflows/on_pull_request-opened-deployment-guide.yml
name: Deployment Guide / On Pull Request Opened

on:
  pull_request:
    types: [opened]

jobs:
  post-help:
    uses: <ã“ã“ã«ã¯ã€Actionsæœ¬ä½“ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å®Ÿéš›ã®ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„>/.github/workflows/_comment-markdown-file.yml@main
    with:
      markdown-file-path: .github/deployment-guide.md
      excluded-users: renovate[bot]
      pr-number: ${{ github.event.pull_request.number }}
```

ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```md:.github/deployment-guide.md
## ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰

ã“ã®PRã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

### ğŸ’» åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

#### dry-runã‚³ãƒãƒ³ãƒ‰
- `.noop` - devç’°å¢ƒã§dry-runãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œï¼ˆå®Ÿéš›ã®å¤‰æ›´ã¯è¡Œã‚ãªã„ï¼‰
- `.noop to <env>` - æŒ‡å®šç’°å¢ƒã§dry-runãƒ¢ãƒ¼ãƒ‰å®Ÿè¡Œ

#### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
- `.deploy` - devç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
- `.deploy to dev` - devç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆæ˜ç¤ºçš„æŒ‡å®šï¼‰
- `.deploy to stg` - stgç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤
- `.deploy to prd` - prdç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤

#### ãã®ä»–
- `.help` - è©³ç´°ãªãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

> ğŸ’¡ **ãƒ’ãƒ³ãƒˆ**: ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰ã«ã€dry-runã‚’å®Ÿè¡Œã—ã¦ãŠãã¨ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼ãŒãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã—ã‚„ã™ããªã‚Šã¾ã™ã€‚

---

### ğŸŒ åˆ©ç”¨å¯èƒ½ãªç’°å¢ƒ

- **dev** (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) - é–‹ç™ºç’°å¢ƒ
- **stg** - ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
- **prd** - æœ¬ç•ªç’°å¢ƒ

---

### ğŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡

ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¿œã˜ã¦ä»¥ä¸‹ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ï¼š

#### devç’°å¢ƒã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
<devlopmentç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã¾ã™>

#### stgç’°å¢ƒã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
<stagingç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã¾ã™>

#### prdç’°å¢ƒã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
<productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã¾ã™>


#### å…¨ç’°å¢ƒã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½
<å…¨ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã¾ã™>

---

### âš™ï¸ è¨­å®š

- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç’°å¢ƒ**: dev
- **å®‰å®šãƒ–ãƒ©ãƒ³ãƒ**: develop
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸è¦ç’°å¢ƒ**: dev, stg
- **Path Filter**: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¿œã˜ã¦è‡ªå‹•çš„ã«å®Ÿè¡Œå¯¾è±¡ã‚’åˆ¤å®š
```

# çµæœ

ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã—ãŸã‚‰ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/e4eb2d50fa43-20251120.png)

# ãŠã¾ã‘

branch-deployã¯`.noop`ã¨ã„ã†dry-runå®Ÿè¡Œã‚’ã™ã‚‹ãŸã‚ã®ãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã‚Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã«`terraform plan`ã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠã„ã¦ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰ã«`.noop`ã®å®Ÿè¡Œçµæœã‚’æ®‹ã—ã¦ãŠã„ã¦ã‚‚ã‚‰ã†ã¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ—ã‚‹ã®ã§ä½•ã‹ã¨ä¾¿åˆ©ã§ã™ã€‚

ä¸‹è¨˜ã®ã‚ˆã†ã«`.noop`ã§å®Ÿè¡Œã—ãŸçµæœã®å·®åˆ†ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ®‹ã™ã‚ˆã†ã«ã™ã‚‹ã¨éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/943b3fb468d4-20251120.png)

# å‚è€ƒ

- https://zenn.dev/simpleform_blog/articles/99cea8c1af0657
  - Github Actionsã®å‘½åæ–¹æ³•ã‚„åˆ†ã‘æ–¹ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚ãŠã™ã™ã‚ï¼
